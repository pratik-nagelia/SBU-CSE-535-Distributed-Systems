from _typeshed import Self
import logging
import math
authorda = import_da('author')
clientda = import_da('client')

config(channel is fifo, clock is lamport)
cfgPath = '../config/config.yaml'

class LeaderElection(process):
    def setup(validators:set, window_size:int, exclude_size:int, reputation_leaders:set):
        self.validators = validators
        self.window_size = window_size
        self.exclude_size = exclude_size
        self.reputation_leaders = reputation_leaders

    def elect_reputation_leader(qc:process):
        active_validators = set()
        last_authors = set()
        current_qc = qc

        for i in range(self.window_size):
            if i < window_size or len(last_authors) < exclude_size:
                current_block = Ledger.committed_block(current_qc.vote_info.parent_id)
                block_author = current_block.author
                if i < window_size:
                    active_validators = active_validators.union(self.current_qc.signatures.signers())
                if len(last_authors) < exclude_size:
                    last_author = last_author.union(block_author)
                current_qc = current_block.qc
        active_validators -= last_authors
        return active_validators[qc.vote_info.round]
    
    def update_leaders(qc:process):
        extended_round = qc.vote_info.parent_round
        qc_round = qc.vote_info.round
        current_round = PaceMaker.current_round
        if extended_round + 1 == qc_round and qc_round + 1 == current_round:
            reputation_leaders[current_round + 1] = elect_reputation_leader(qc)

    def get_leader(round):
        if round < len(reputation_leaders):
            return reputation_leaders[round]
        return validators[math.floor(round/2) % len(validators)]