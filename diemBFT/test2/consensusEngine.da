import yaml
import logging
authorda = import_da('author')
clientda = import_da('client')

config(channel is fifo, clock is lamport)
cfgPath = 'config/config.yaml'

def main():
    # Read the config from the file
    with open(cfgPath, 'r') as stream:
        try:
            cfg = yaml.safe_load(stream)
            print(cfg)
        except yaml.YAMLError as exc:
            print(exc)

    output('[ENGINE] Config read from ', cfgPath)

    # Create a client which will fire requests to all the validators
    clients = new(clientda.Client, num= cfg['clientCount'])

    # Create as many validators as specified in the config
    validators = new(authorda.Author, num= cfg['n'])
    output('[ENGINE] Validators created.')

    vNumber = 0
    authorMap = {}
    print('[ENGINE]: first v loop')
    for v in validators:
        print(str(v))
        authorMap[vNumber] = v
        vNumber += 1

    print('[ENGINE]: second v loop')
    vNumber = 0
    for v in validators:
        print(str(v))
        setup(v, (validators, validators-{v}, vNumber, authorMap))
        vNumber += 1

    output('[ENGINE] Validators setup done.')

    # Setup and start the client
    for c in clients:
        setup(c, (validators,))

    output('[ENGINE] Client setup done.')

    start(validators)
    start(clients)
    await(False)
